<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>HoloMeet VR PRO</title>

<!-- A-FRAME -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<!-- PHYSICS -->
<script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>

<!-- SOCKET -->
<script src="/socket.io/socket.io.js"></script>

<style>
body { margin:0; overflow:hidden; }
</style>
</head>

<body>

<a-scene
  vr-mode-ui="enabled: true"
  physics="gravity:-9.8"
  renderer="physicallyCorrectLights:true">

  <!-- LUCES -->
  <a-entity light="type: ambient; intensity:0.5"></a-entity>
  <a-entity light="type: directional; intensity:1" position="5 10 5"></a-entity>

  <!-- SALA -->
  <a-entity
    gltf-model="url(/Untitled.glb)"
    static-body>
  </a-entity>

  <!-- ðŸ“º TV / DASHBOARD -->
  <a-plane
    id="dashboard"
    position="0 2 -5"
    width="4"
    height="2.5"
    color="#111"
    class="raycastable">
  </a-plane>

  <!-- ðŸª‘ SILLAS (COLISIONES) -->
  <a-entity id="chairs">
    <a-box class="chair" data-index="0" position="0 0 -2" static-body></a-box>
    <a-box class="chair" data-index="1" position="1 0 -2" static-body></a-box>
    <a-box class="chair" data-index="2" position="-1 0 -2" static-body></a-box>
    <a-box class="chair" data-index="3" position="0 0 -3" static-body></a-box>
    <a-box class="chair" data-index="4" position="1 0 -3" static-body></a-box>
    <a-box class="chair" data-index="5" position="-1 0 -3" static-body></a-box>
    <a-box class="chair" data-index="6" position="0 0 -4" static-body></a-box>
  </a-entity>

  <!-- ðŸ‘¤ PLAYER -->
  <a-entity id="rig" position="0 1.6 3" dynamic-body>

    <!-- CÃMARA -->
    <a-entity
      id="camera"
      camera
      look-controls
      wasd-controls="acceleration:20">
    </a-entity>

    <!-- AVATAR SIMPLE -->
    <a-cylinder id="body" height="1.2" radius="0.25" color="#00f3ff" position="0 -0.6 0"></a-cylinder>

    <!-- ðŸŽ¤ AUDIO ESPACIAL -->
    <a-sound
      id="voice"
      positional="true"
      autoplay="true">
    </a-sound>

    <!-- ðŸ–ï¸ MANO IZQUIERDA -->
    <a-entity
      hand-controls="hand:left"
      raycaster="objects: .raycastable"
      laser-controls="hand:left">
    </a-entity>

    <!-- ðŸ–ï¸ MANO DERECHA + LÃSER -->
    <a-entity
      id="rightHand"
      hand-controls="hand:right"
      raycaster="objects: .raycastable"
      laser-controls="hand:right">
    </a-entity>

  </a-entity>

</a-scene>

<script>
/* ================= SOCKET ================= */
const socket = io();
const params = new URLSearchParams(window.location.search);
const roomId = params.get('room') || 'default';
const username = params.get('username') || 'Guest';

socket.emit('join-room', { roomId, username });

/* ================= AUDIO ESPACIAL REAL ================= */
navigator.mediaDevices.getUserMedia({ audio:true }).then(stream => {
  const audio = document.querySelector('#voice');
  audio.components.sound.pool.children[0].srcObject = stream;
});

/* ================= SILLAS + ANIMACIÃ“N ================= */
let seated = false;

document.querySelectorAll('.chair').forEach(chair => {
  chair.addEventListener('click', () => {
    if (seated) return;
    seated = true;

    document.querySelector('#camera').removeAttribute('wasd-controls');
    document.querySelector('#body').setAttribute('scale', '1 0.6 1');

    document.querySelector('#rig')
      .setAttribute('position', chair.getAttribute('position'));

    socket.emit('sit-chair', {
      roomId,
      chairIndex: chair.dataset.index
    });
  });
});

window.addEventListener('keydown', e => {
  if (e.key === ' ' && seated) {
    seated = false;
    document.querySelector('#camera')
      .setAttribute('wasd-controls', 'acceleration:20');
    document.querySelector('#body').setAttribute('scale', '1 1 1');
  }
});

/* ================= LÃSER EN DASHBOARD ================= */
document.querySelector('#rightHand')
  .addEventListener('raycaster-intersection', e => {
    const hit = e.detail.els[0];
    if (hit && hit.id === 'dashboard') {
      hit.setAttribute('color', '#333');
    }
  });
</script>

</body>
</html>
