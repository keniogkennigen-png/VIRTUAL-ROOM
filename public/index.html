<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>HoloMeet VR</title>

<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
body { margin:0; overflow:hidden; }
#ui {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10;
  background: rgba(0,0,0,0.6);
  padding: 10px;
  color: white;
}
</style>
</head>

<body>

<div id="ui">
  <input type="file" id="pdfInput"><br><br>
  <input type="text" id="ytInput" placeholder="YouTube URL">
  <button onclick="shareVideo()">Video</button>
</div>

<a-scene vr-mode-ui="enabled: true">

  <!-- LUCES -->
  <a-entity light="type: ambient; intensity:0.6"></a-entity>
  <a-entity light="type: directional; intensity:1" position="5 10 5"></a-entity>

  <!-- SALA -->
  <a-entity gltf-model="url(/Untitled.glb)"></a-entity>

  <!-- ðŸª‘ SILLAS -->
  <a-entity id="chairs">
    <a-box class="chair" data-index="0" position="0 0 -2"></a-box>
    <a-box class="chair" data-index="1" position="1 0 -2"></a-box>
    <a-box class="chair" data-index="2" position="-1 0 -2"></a-box>
    <a-box class="chair" data-index="3" position="0 0 -3"></a-box>
    <a-box class="chair" data-index="4" position="1 0 -3"></a-box>
    <a-box class="chair" data-index="5" position="-1 0 -3"></a-box>
    <a-box class="chair" data-index="6" position="0 0 -4"></a-box>
  </a-entity>

  <!-- ðŸ“º PANTALLA -->
  <a-plane id="screen" position="0 2 -5" width="4" height="2.5" color="#111"></a-plane>

  <!-- ðŸ‘¤ USUARIO -->
  <a-entity id="rig" position="0 0 3">
    <a-entity id="camera" camera look-controls wasd-controls="acceleration:20"></a-entity>

    <!-- AVATAR -->
    <a-cylinder id="body" height="1.2" radius="0.25" color="#00f3ff" position="0 0.6 0"></a-cylinder>
    <a-sphere radius="0.22" color="#ffd1a9" position="0 1.5 0"></a-sphere>

    <!-- MANOS VR -->
    <a-entity hand-controls="hand:left"></a-entity>
    <a-entity hand-controls="hand:right"></a-entity>
  </a-entity>

</a-scene>

<script>
/* ================= SOCKET ================= */
const socket = io();
const params = new URLSearchParams(window.location.search);
const roomId = params.get('room') || 'default';
const username = params.get('username') || 'Guest';

socket.emit('join-room', { roomId, username });

/* ================= SILLAS ================= */
const chairs = document.querySelectorAll('.chair');
const lockedChairs = {};
let seated = false;

chairs.forEach(chair => {
  chair.setAttribute('color', 'green');
  chair.addEventListener('click', () => {
    const i = chair.dataset.index;
    if (lockedChairs[i]) return;
    socket.emit('sit-chair', { roomId, chairIndex: i });
  });
});

socket.on('room-users', users => {
  Object.keys(lockedChairs).forEach(k => delete lockedChairs[k]);

  chairs.forEach(c => c.setAttribute('color', 'green'));

  users.forEach(u => {
    if (u.chairIndex !== null) {
      lockedChairs[u.chairIndex] = u.id;
      document.querySelector(`.chair[data-index="${u.chairIndex}"]`)
        .setAttribute('color', 'red');

      if (u.id === socket.id) {
        seated = true;
        document.getElementById('camera').removeAttribute('wasd-controls');
        document.getElementById('rig')
          .setAttribute('position',
            document.querySelector(`.chair[data-index="${u.chairIndex}"]`)
            .getAttribute('position'));
      }
    }
  });
});

window.addEventListener('keydown', e => {
  if (e.key === ' ' && seated) {
    seated = false;
    document.getElementById('camera')
      .setAttribute('wasd-controls', 'acceleration:20');
  }
});

/* ================= AVATARES OTROS ================= */
const avatars = {};

socket.on('user-joined', user => {
  if (avatars[user.id]) return;

  const avatar = document.createElement('a-entity');
  avatar.innerHTML = `
    <a-cylinder height="1.2" radius="0.25" color="#aaa" position="0 0.6 0"></a-cylinder>
    <a-sphere radius="0.22" color="#ffd1a9" position="0 1.5 0"></a-sphere>
  `;
  avatar.setAttribute('id', `avatar-${user.id}`);
  document.querySelector('a-scene').appendChild(avatar);
  avatars[user.id] = avatar;
});

socket.on('user-left', user => {
  avatars[user.id]?.remove();
  delete avatars[user.id];
});

/* ================= AUDIO ESPACIAL ================= */
navigator.mediaDevices.getUserMedia({ audio:true }).then(stream => {
  const audio = document.createElement('audio');
  audio.srcObject = stream;
  audio.muted = true;
  audio.play();

  const sound = document.createElement('a-sound');
  sound.setAttribute('src', audio);
  sound.setAttribute('positional', 'true');
  document.getElementById('rig').appendChild(sound);
});

/* ================= PDF / VIDEO ================= */
document.getElementById('pdfInput').addEventListener('change', e => {
  const r = new FileReader();
  r.onload = () => socket.emit('share-pdf', { roomId, pdfData:r.result });
  r.readAsDataURL(e.target.files[0]);
});

function shareVideo() {
  socket.emit('share-video', {
    roomId,
    videoUrl: document.getElementById('ytInput').value
  });
}

socket.on('content-update', data => {
  const screen = document.getElementById('screen');
  if (data.type === 'pdf') screen.setAttribute('material','src',data.data);
  if (data.type === 'video')
    screen.setAttribute('material','src',
      `https://www.youtube.com/embed/${data.data.split("v=")[1]}`);
});
</script>

</body>
</html>
