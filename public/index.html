<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HUB ALONE - Virtual Collaborative Room</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }

        /* HUB ALONE SIDEBAR */
        #hub-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-right: 2px solid #00f3ff;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        #hub-sidebar h2 {
            color: #00f3ff;
            font-size: 18px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #00f3ff;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #00f3ff;
        }

        .section-title {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
            margin: 10px 0 5px;
            letter-spacing: 1px;
        }

        /* ROOM INFO */
        #room-info {
            background: rgba(0,243,255,0.1);
            border: 1px solid #00f3ff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: center;
        }

        #room-info .room-name { color: #00f3ff; font-weight: bold; font-size: 14px; }
        #room-info .user-count { color: #888; font-size: 11px; margin-top: 5px; }

        /* CHAT */
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-bottom: 10px;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        #messages::-webkit-scrollbar { width: 5px; }
        #messages::-webkit-scrollbar-track { background: #1a1a2e; }
        #messages::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 3px; }

        .message {
            margin-bottom: 6px;
            padding: 5px 8px;
            background: rgba(0,243,255,0.1);
            border-left: 2px solid #00f3ff;
            border-radius: 0 5px 5px 0;
        }

        .message .user { color: #00f3ff; font-weight: bold; }
        .message .time { color: #555; font-size: 10px; margin-left: 5px; }
        .message.system { background: rgba(255,193,7,0.2); border-left-color: #ffc107; color: #ffc107; }

        #chat-input {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border: 1px solid #333;
            border-radius: 5px;
            color: #fff;
            font-size: 12px;
            outline: none;
        }

        #chat-input:focus { border-color: #00f3ff; }

        /* BUTTONS */
        .btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #00f3ff 0%, #00a8cc 100%);
            border: none;
            border-radius: 5px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,243,255,0.4); }

        .btn.secondary { background: linear-gradient(135deg, #333 0%, #222 100%); color: #fff; }
        .btn.red { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); color: #fff; }

        /* MAIN CANVAS */
        #canvas-container {
            position: fixed;
            left: 280px;
            top: 0;
            width: calc(100vw - 280px);
            height: 100vh;
        }

        /* UTC CLOCK */
        #utc-clock {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #00f3ff;
            font-size: 14px;
            font-family: monospace;
            text-shadow: 0 0 10px #00f3ff;
            z-index: 100;
        }

        /* DASHBOARD TOGGLE */
        #dashboard-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #00f3ff 0%, #00a8cc 100%);
            border: none;
            border-radius: 50%;
            color: #000;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0,243,255,0.5);
            z-index: 500;
            transition: all 0.3s;
        }

        #dashboard-toggle:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(0,243,255,0.8); }

        /* DASHBOARD PANEL */
        #dashboard {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 950px;
            height: 650px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 2px solid #00f3ff;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,243,255,0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 2000;
        }

        #dashboard.active { display: flex; }

        #dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(90deg, rgba(0,243,255,0.1) 0%, transparent 100%);
            border-bottom: 1px solid #00f3ff;
        }

        #dashboard-header h3 { color: #00f3ff; font-size: 16px; text-transform: uppercase; letter-spacing: 3px; }

        #dashboard-close {
            background: transparent;
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        #dashboard-close:hover { background: #ff6b6b; color: #000; }

        #dashboard-content { flex: 1; display: flex; overflow: hidden; }

        #dashboard-controls {
            width: 220px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid #333;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dashboard-btn {
            padding: 12px;
            background: rgba(0,243,255,0.1);
            border: 1px solid #00f3ff;
            border-radius: 5px;
            color: #00f3ff;
            cursor: pointer;
            font-size: 11px;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .dashboard-btn:hover { background: rgba(0,243,255,0.2); transform: translateX(5px); }
        .dashboard-btn.active { background: #00f3ff; color: #000; }

        .share-area {
            background: rgba(0,0,0,0.2);
            border: 1px dashed #333;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .share-area label { display: block; color: #888; font-size: 10px; margin-bottom: 5px; text-transform: uppercase; }
        .share-area input {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border: 1px solid #333;
            border-radius: 5px;
            color: #fff;
            font-size: 12px;
            margin-bottom: 8px;
            outline: none;
        }

        .share-area input:focus { border-color: #00f3ff; }

        #dashboard-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            background: #000;
        }

        #dashboard-main iframe { width: 100%; height: 100%; border: none; border-radius: 5px; }
        #dashboard-main canvas { max-width: 100%; max-height: 100%; border-radius: 5px; }

        .placeholder { text-align: center; color: #555; }
        .placeholder-icon { font-size: 60px; margin-bottom: 15px; }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.7);
            z-index: 1500;
            display: none;
        }

        #overlay.active { display: block; }

        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #login-modal.hidden { display: none; }

        #login-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #00f3ff;
            border-radius: 10px;
            padding: 30px;
            width: 350px;
            text-align: center;
        }

        #login-box h2 { color: #00f3ff; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }

        #login-box input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.4);
            border: 1px solid #333;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
            outline: none;
        }

        #login-box input:focus { border-color: #00f3ff; }
        #login-box button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00f3ff 0%, #00a8cc 100%);
            border: none;
            border-radius: 5px;
            color: #000;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
        }

        #notification {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: rgba(0,243,255,0.9);
            color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            z-index: 2500;
            display: none;
        }

        #notification.show { display: block; }
    </style>
</head>
<body>

<!-- LOGIN MODAL -->
<div id="login-modal">
    <div id="login-box">
        <h2>üè¢ Hub Alone</h2>
        <input type="text" id="username-input" placeholder="Enter your name..." maxlength="20">
        <input type="text" id="room-input" placeholder="Room name" value="Main-Room">
        <button onclick="joinRoom()">Enter Room</button>
    </div>
</div>

<!-- HUB ALONE SIDEBAR -->
<div id="hub-sidebar">
    <h2>üè¢ Hub Alone</h2>

    <div id="room-info">
        <div class="room-name">üìç <span id="current-room">---</span></div>
        <div class="user-count">üë• <span id="user-count">0</span> users online</div>
    </div>

    <div class="section-title">Chat</div>
    <div id="chat-container">
        <div id="messages"></div>
        <input type="text" id="chat-input" placeholder="Type message...">
    </div>

    <div class="section-title">Dashboard Controls</div>
    <button class="btn" id="dashboard-toggle-btn">üìä Open Dashboard</button>
    <button class="btn secondary" id="reset-view-btn">Reset View (R)</button>
</div>

<!-- MAIN CANVAS -->
<div id="canvas-container"></div>

<!-- UTC CLOCK -->
<div id="utc-clock">UTC: 00:00:00</div>

<!-- DASHBOARD TOGGLE -->
<button id="dashboard-toggle" title="Open Dashboard">üìä</button>

<!-- OVERLAY -->
<div id="overlay"></div>

<!-- NOTIFICATION -->
<div id="notification"></div>

<!-- DASHBOARD PANEL -->
<div id="dashboard">
    <div id="dashboard-header">
        <h3>üìä Dashboard - Shared Content</h3>
        <button id="dashboard-close">‚úï Close</button>
    </div>
    <div id="dashboard-content">
        <div id="dashboard-controls">
            <button class="dashboard-btn active" data-mode="none" onclick="setDashboardMode('none')">üìÑ No Content</button>
            <button class="dashboard-btn" data-mode="pdf" onclick="setDashboardMode('pdf')">üìë PDF Viewer</button>
            <button class="dashboard-btn" data-mode="video" onclick="setDashboardMode('video')">üé¨ Video / URL</button>

            <div id="pdf-share-area" class="share-area" style="display:none;">
                <label>üìÑ Upload PDF (everyone sees)</label>
                <input type="file" id="pdf-file-input" accept=".pdf" onchange="handlePdfUpload(this)">
            </div>

            <div id="video-share-area" class="share-area" style="display:none;">
                <label>üé¨ Share Video URL</label>
                <input type="text" id="video-url-input" placeholder="YouTube, Vimeo, MP4 URL...">
                <input type="text" id="video-title-input" placeholder="Video title (optional)">
                <button class="dashboard-btn" onclick="shareVideoUrl()" style="width:100%;">üì§ Share to All</button>
            </div>

            <button class="dashboard-btn red" onclick="clearContent()" style="margin-top:auto;">üóëÔ∏è Clear Content</button>
        </div>
        <div id="dashboard-main">
            <div class="placeholder" id="dashboard-placeholder">
                <div class="placeholder-icon">üìä</div>
                <p>No shared content</p>
                <p style="font-size: 11px; color: #555;">Select PDF or Video to share with everyone</p>
            </div>
            <iframe id="content-frame" style="display:none;" allowfullscreen></iframe>
            <canvas id="pdf-render" style="display:none;"></canvas>
        </div>
    </div>
</div>

<script>
    // ==================== CONFIG ====================
    let socket;
    let currentRoom = 'Main-Room';
    let currentUser = 'Guest';
    let currentMode = 'none';

    // ==================== JOIN ROOM ====================
    function joinRoom() {
        const username = document.getElementById('username-input').value.trim() || 'Guest';
        const room = document.getElementById('room-input').value.trim() || 'Main-Room';

        currentUser = username;
        currentRoom = room;

        socket = io();

        socket.on('connect', () => {
            socket.emit('join-room', { roomId: currentRoom, username: currentUser });
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('current-room').textContent = currentRoom;
            showNotification(`Welcome ${currentUser}!`);
        });

        socket.on('room-state', (roomState) => {
            document.getElementById('user-count').textContent = roomState.users.length;
            if (roomState.content && roomState.content.type !== 'none') {
                displayContent(roomState.content);
            }
        });

        socket.on('room-users', (users) => {
            document.getElementById('user-count').textContent = users.length;
        });

        socket.on('user-joined', (user) => {
            addMessage('System', `${user.username} joined the room`);
        });

        socket.on('user-left', (user) => {
            addMessage('System', `${user.username} left the room`);
        });

        socket.on('new-message', (msg) => {
            addMessage(msg.user, msg.text, msg.time, msg.user === 'System');
        });

        socket.on('content-update', (content) => {
            displayContent(content);
        });
    }

    // ==================== CHAT ====================
    function setupChat() {
        const input = document.getElementById('chat-input');
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                socket.emit('chat-message', { roomId: currentRoom, message: input.value });
                input.value = '';
            }
        });
    }

    function addMessage(user, text, time = null, isSystem = false) {
        const container = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = `message${isSystem ? ' system' : ''}`;
        const timeStr = time ? new Date(time).toLocaleTimeString() : '';
        div.innerHTML = `<span class="user">${user}:</span> ${text}${timeStr ? `<span class="time">${timeStr}</span>` : ''}`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // ==================== DASHBOARD ====================
    function setupDashboard() {
        document.getElementById('dashboard-toggle').onclick = () => toggleDashboard(true);
        document.getElementById('dashboard-toggle-btn').onclick = () => toggleDashboard(true);
        document.getElementById('dashboard-close').onclick = () => toggleDashboard(false);
        document.getElementById('overlay').onclick = () => toggleDashboard(false);
    }

    function toggleDashboard(show) {
        const dashboard = document.getElementById('dashboard');
        const overlay = document.getElementById('overlay');
        if (show) {
            dashboard.classList.add('active');
            overlay.classList.add('active');
        } else {
            dashboard.classList.remove('active');
            overlay.classList.remove('active');
        }
    }

    function setDashboardMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.dashboard-btn[data-mode]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        document.getElementById('pdf-share-area').style.display = mode === 'pdf' ? 'block' : 'none';
        document.getElementById('video-share-area').style.display = mode === 'video' ? 'block' : 'none';

        if (mode === 'none') {
            document.getElementById('dashboard-placeholder').style.display = 'block';
            document.getElementById('content-frame').style.display = 'none';
            document.getElementById('pdf-render').style.display = 'none';
        }
    }

    // ==================== PDF SHARING ====================
    function handlePdfUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            socket.emit('share-pdf', {
                roomId: currentRoom,
                pdfData: e.target.result,
                filename: file.name
            });
            showNotification('PDF shared with room!');
        };
        reader.readAsArrayBuffer(file);
    }

    function displayPdf(pdfData) {
        const canvas = document.getElementById('pdf-render');
        document.getElementById('dashboard-placeholder').style.display = 'none';
        document.getElementById('content-frame').style.display = 'none';
        canvas.style.display = 'block';

        pdfjsLib.getDocument(new Uint8Array(pdfData)).promise.then(pdf => {
            pdf.getPage(1).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport });
            });
        });
    }

    // ==================== VIDEO SHARING ====================
    function shareVideoUrl() {
        const url = document.getElementById('video-url-input').value.trim();
        const title = document.getElementById('video-title-input').value.trim() || url;

        if (!url) {
            showNotification('Please enter a video URL');
            return;
        }

        socket.emit('share-video', {
            roomId: currentRoom,
            videoUrl: url,
            title: title
        });

        document.getElementById('video-url-input').value = '';
        document.getElementById('video-title-input').value = '';
        showNotification('Video shared with room!');
    }

    function displayVideo(videoUrl) {
        const frame = document.getElementById('content-frame');
        document.getElementById('dashboard-placeholder').style.display = 'none';
        document.getElementById('pdf-render').style.display = 'none';
        frame.style.display = 'block';

        let embedUrl = videoUrl;

        const ytMatch = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);
        if (ytMatch) {
            embedUrl = `https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1`;
        } else if (videoUrl.includes('vimeo.com')) {
            const vimeoMatch = videoUrl.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) {
                embedUrl = `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1`;
            }
        }

        frame.src = embedUrl;
    }

    function clearContent() {
        socket.emit('clear-content', { roomId: currentRoom });
        showNotification('Content cleared');
    }

    function displayContent(content) {
        if (content.type === 'pdf' && content.data) {
            setDashboardMode('pdf');
            displayPdf(content.data);
        } else if (content.type === 'video' && content.data) {
            setDashboardMode('video');
            displayVideo(content.data);
        } else {
            setDashboardMode('none');
        }
    }

    // ==================== THREE.JS ====================
    let scene, camera, renderer, centralMesh;

    function initThreeJS() {
        const container = document.getElementById('canvas-container');

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x010103);
        scene.fog = new THREE.FogExp2(0x010103, 0.03);

        camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 2, 8);
        camera.lookAt(0, 1.5, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        container.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0x404040, 0.5));
        const mainLight = new THREE.PointLight(0x00f3ff, 1, 50);
        mainLight.position.set(0, 10, 0);
        scene.add(mainLight);

        scene.add(new THREE.GridHelper(50, 50, 0x00f3ff, 0x002222));

        const geometry = new THREE.OctahedronGeometry(1, 0);
        const material = new THREE.MeshStandardMaterial({
            color: 0x00f3ff, emissive: 0x00f3ff, emissiveIntensity: 0.3,
            metalness: 0.8, roughness: 0.2
        });
        centralMesh = new THREE.Mesh(geometry, material);
        centralMesh.position.set(0, 1.5, 0);
        scene.add(centralMesh);

        for (let i = 0; i < 3; i++) {
            const ring = new THREE.Mesh(
                new THREE.TorusGeometry(3 + i * 0.5, 0.02, 16, 100),
                new THREE.MeshBasicMaterial({ color: 0x00f3ff, transparent: true, opacity: 0.3 - i * 0.1 })
            );
            ring.rotation.x = Math.PI / 2;
            ring.position.y = 0.5 + i * 0.5;
            scene.add(ring);
        }

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        function animate() {
            requestAnimationFrame(animate);
            if (centralMesh) {
                centralMesh.rotation.y += 0.02;
                centralMesh.position.y = 1.5 + Math.sin(Date.now() * 0.001) * 0.2;
            }
            renderer.render(scene, camera);
        }
        animate();
    }

    // ==================== UTILITIES ====================
    function setupClock() {
        function update() {
            const d = new Date();
            document.getElementById('utc-clock').textContent =
                'UTC: ' + d.getUTCHours().toString().padStart(2,'0') + ':' +
                d.getUTCMinutes().toString().padStart(2,'0') + ':' +
                d.getUTCSeconds().toString().padStart(2,'0');
        }
        update();
        setInterval(update, 1000);
    }

    function setupResetView() {
        document.getElementById('reset-view-btn').onclick = () => {
            camera.position.set(0, 2, 8);
            camera.lookAt(0, 1.5, 0);
        };
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                camera.position.set(0, 2, 8);
                camera.lookAt(0, 1.5, 0);
            }
        });
    }

    function showNotification(msg) {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.classList.add('show');
        setTimeout(() => notif.classList.remove('show'), 3000);
    }

    // ==================== INITIALIZE ====================
    window.onload = function() {
        initThreeJS();
        setupChat();
        setupDashboard();
        setupClock();
        setupResetView();
    };
</script>
</body>
</html>
