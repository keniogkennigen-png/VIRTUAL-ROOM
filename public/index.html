<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>HoloMeet VR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<!-- SOCKET -->
<script src="/socket.io/socket.io.js"></script>

<style>
body { margin:0; overflow:hidden; background:#000; font-family:monospace }
#hud {
  position:fixed; top:10px; left:10px;
  color:#00f3ff; border:1px solid #00f3ff;
  padding:8px; background:rgba(0,0,0,.6)
}
#utc {
  position:fixed; top:10px; right:10px;
  color:#00f3ff; border:1px solid #00f3ff;
  padding:8px; background:rgba(0,0,0,.6)
}
#controls {
  position:fixed; bottom:10px; left:50%;
  transform:translateX(-50%);
}
button {
  background:#00f3ff; border:none;
  padding:10px 14px; margin:4px;
  font-weight:bold; cursor:pointer;
}
</style>
</head>

<body>

<div id="hud">SESSION: <span id="room"></span></div>
<div id="utc">UTC: --:--:--</div>

<div id="controls">
<button onclick="uploadPDF()">SUBIR PDF</button>
<button onclick="shareYT()">YOUTUBE</button>
</div>

<script>
/* =======================
   SESSION
======================= */
const params = new URLSearchParams(location.search);
const ROOM = params.get("room") || "LOBBY";
document.getElementById("room").textContent = ROOM;

/* =======================
   SOCKET
======================= */
const socket = io();
socket.emit("join-room",{ roomId:ROOM, username:"Guest" });

/* =======================
   THREE CORE
======================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0,1.6,5);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

/* =======================
   LIGHTING
======================= */
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.1));
const dir = new THREE.DirectionalLight(0xffffff,0.8);
dir.position.set(5,10,2);
scene.add(dir);

/* =======================
   CONTROLS
======================= */
const controls = new THREE.PointerLockControls(camera, document.body);
document.body.onclick = () => controls.lock();

const keys = {};
onkeydown = e => keys[e.code]=true;
onkeyup = e => keys[e.code]=false;

/* =======================
   LOAD ROOM
======================= */
const loader = new THREE.GLTFLoader();
const colliders = [];
const chairs = {};

loader.load("./Untitled.glb", gltf=>{
  gltf.scene.traverse(o=>{
    if(o.isMesh){
      o.castShadow = true;
      o.receiveShadow = true;

      /* ---- CHAIRS (7) ---- */
      if(o.name.startsWith("weaving3DAlanaOfficeChairFabricMesh001_chair")){
        chairs[o.name] = o;
        colliders.push(o);
      }

      /* ---- TABLE / WALLS ---- */
      if(o.name.includes("Table") || o.name.includes("Wall")){
        colliders.push(o);
      }

      /* ---- DASHBOARD ---- */
      if(o.name==="pCube76_TV_0"){
        tvMesh = o;
      }
    }
  });
  scene.add(gltf.scene);
});

/* =======================
   TV SCREEN
======================= */
let tvMesh=null;
const tvCanvas = document.createElement("canvas");
tvCanvas.width=1024; tvCanvas.height=512;
const tvCtx = tvCanvas.getContext("2d");
const tvTex = new THREE.CanvasTexture(tvCanvas);

function drawTV(text){
  tvCtx.fillStyle="#003333";
  tvCtx.fillRect(0,0,1024,512);
  tvCtx.fillStyle="#00f3ff";
  tvCtx.font="40px monospace";
  tvCtx.fillText(text,50,100);
  tvTex.needsUpdate=true;
  if(tvMesh) tvMesh.material.map=tvTex;
}
drawTV("HOLOMEET READY");

/* =======================
   PDF / YOUTUBE
======================= */
function uploadPDF(){
  const i=document.createElement("input");
  i.type="file"; i.accept="application/pdf";
  i.onchange=()=>{
    drawTV("PDF CARGADO");
    socket.emit("share-pdf",{roomId:ROOM});
  };
  i.click();
}
function shareYT(){
  const url=prompt("YouTube URL");
  if(url){ drawTV("VIDEO"); socket.emit("share-video",{roomId:ROOM,videoUrl:url}); }
}

/* =======================
   COLLISION SIMPLE
======================= */
const ray = new THREE.Raycaster();
function canMove(dir){
  ray.set(camera.position, dir);
  const hit = ray.intersectObjects(colliders,true);
  return hit.length===0 || hit[0].distance>0.5;
}

/* =======================
   LOOP
======================= */
function animate(){
  requestAnimationFrame(animate);
  const speed=0.05;
  if(keys["KeyW"] && canMove(camera.getWorldDirection(new THREE.Vector3()))) controls.moveForward(speed);
  if(keys["KeyS"]) controls.moveForward(-speed);
  if(keys["KeyA"]) controls.moveRight(-speed);
  if(keys["KeyD"]) controls.moveRight(speed);
  renderer.render(scene,camera);
}
animate();

/* =======================
   UTC CLOCK
======================= */
setInterval(()=>{
  document.getElementById("utc").textContent =
    "UTC: "+new Date().toISOString().substr(11,8);
},1000);

onresize=()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
};
</script>

</body>
</html>
